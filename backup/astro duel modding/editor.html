<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur de Niveaux XML</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        h1 {
            text-align: center;
        }

        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .properties {
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fff;
            margin-bottom: 20px;
        }

        .matrix {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .row {
            display: flex;
        }

        .tile {
            width: 20px;
            height: 20px;
            margin: 0;
            background-color: transparent;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            cursor: pointer;
            margin: 5px;
            border: 1px solid #000;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Éditeur de Niveaux XML</h1>
        <button id="loadButton">Charger Niveau XML</button>
        <div id="properties" class="properties"></div>
        <div id="controls" class="controls">
            <button id="prevLayerButton">Couche Précédente</button>
            <button id="nextLayerButton">Couche Suivante</button>
        </div>
        <div id="matrix" class="matrix"></div>
        <div class="color-palette" id="colorPalette"></div>
        <button id="saveButton">Sauvegarder Niveau XML</button>
    </div>

    <script>
        let currentLayerIndex = 0;
        let layers = [];
        let xmlDoc = null;
        let currentFileName = ""; // Pour stocker le nom du fichier chargé

        document.getElementById("loadButton").addEventListener("click", loadLevel);
        document.getElementById("prevLayerButton").addEventListener("click", () => changeLayer(-1));
        document.getElementById("nextLayerButton").addEventListener("click", () => changeLayer(1));
        document.getElementById("saveButton").addEventListener("click", saveLevel);

        function loadLevel() {
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = ".xml, .tmx";
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    currentFileName = file.name.replace(/\.xml$|\.tmx$/i, ""); // Stocke le nom du fichier sans extension
                    reader.onload = (e) => {
                        const xmlContent = e.target.result;
                        parseXML(xmlContent);
                    };
                    reader.readAsText(file);
                }
            };
            fileInput.click();
        }

        function parseXML(xmlContent) {
            const parser = new DOMParser();
            xmlDoc = parser.parseFromString(xmlContent, "text/xml");

            displayProperties(xmlDoc);
            layers = Array.from(xmlDoc.getElementsByTagName("layer"));
            currentLayerIndex = 0;
            displayLayer();
            populateColorPalette(); // Ajout de la palette de couleurs
        }

        function displayProperties(xmlDoc) {
            const propertiesDiv = document.getElementById("properties");
            propertiesDiv.innerHTML = ""; // Clear previous properties

            const properties = xmlDoc.getElementsByTagName("properties")[0];
            if (properties) {
                for (const prop of properties.children) {
                    const name = prop.getAttribute("name");
                    const value = prop.getAttribute("value");
                    propertiesDiv.innerHTML += `<p>${name}: ${value}</p>`;
                }
            } else {
                propertiesDiv.innerHTML = "<p>Aucune propriété trouvée.</p>";
            }
        }

        function displayLayer() {
            const matrixDiv = document.getElementById("matrix");
            matrixDiv.innerHTML = ""; // Clear previous layer

            const layer = layers[currentLayerIndex];
            const layerName = layer.getAttribute("name") || "Layer";
            const width = parseInt(layer.getAttribute("width"), 10);
            const height = parseInt(layer.getAttribute("height"), 10);
            const dataElem = layer.getElementsByTagName("data")[0];

            if (dataElem && dataElem.textContent) {
                const tileData = dataElem.textContent.trim().split(",").map(Number);
                const matrix = Array.from({ length: height }, (_, i) =>
                    tileData.slice(i * width, (i + 1) * width)
                );

                matrix.forEach((row, rowIndex) => {
                    const rowDiv = document.createElement("div");
                    rowDiv.className = "row";
                    row.forEach((tile, colIndex) => {
                        const tileDiv = document.createElement("div");
                        tileDiv.className = "tile";
                        tileDiv.style.backgroundColor = getTileColor(layerName, tile);
                        tileDiv.dataset.value = tile;
                        tileDiv.dataset.row = rowIndex;
                        tileDiv.dataset.col = colIndex;
                        tileDiv.addEventListener("click", () => applyColorToTile(tileDiv));
                        rowDiv.appendChild(tileDiv);
                    });
                    matrixDiv.appendChild(rowDiv);
                });
            }
        }

        function changeLayer(direction) {
            currentLayerIndex += direction;
            if (currentLayerIndex < 0) {
                currentLayerIndex = layers.length - 1; // Retour à la dernière couche
            } else if (currentLayerIndex >= layers.length) {
                currentLayerIndex = 0; // Retour à la première couche
            }
            displayLayer();
        }

        function getTileColor(layerName, tileValue) {
            // Couleurs personnalisées par type de couche
            if (layerName.toLowerCase().includes("fg")) {
                if (tileValue === 0) return "#ffffff"; // Blanc pour 0
                else if (tileValue === 84) return "#000000"; // Noir pour 84
                else if (tileValue === 74) return "#808080"; // Gris pour 74
                else return "#cccccc"; // Gris clair par défaut pour les autres valeurs
            } else if (layerName.toLowerCase().includes("bg")) {
                return tileValue === 0 ? "#888888" : "#444444"; // Gris clair pour 0, Gris foncé pour les autres
            } else if (layerName.toLowerCase().includes("detail")) {
                return "#ffa500"; // Orange pour les détails
            } else if (layerName.toLowerCase().includes("spawn")) {
                return tileValue === 0 ? "#00ff00" : "#ff00ff"; // Vert pour 0, Magenta pour les autres
            } else {
                // Couleurs par défaut pour les autres valeurs
                return tileValue === 0 ? "#ff0000" : "#0000ff"; // Rouge pour 0, Bleu pour les autres
            }
        }

        function populateColorPalette() {
            const colorPaletteDiv = document.getElementById("colorPalette");
            colorPaletteDiv.innerHTML = ""; // Clear previous palette

            const colors = [
                { value: 0, color: "#ffffff" },
                { value: 84, color: "#000000" },
                { value: 74, color: "#808080" },
                { value: 1, color: "#cccccc" },
                { value: 2, color: "#ff0000" },
                { value: 3, color: "#0000ff" },
                { value: 4, color: "#00ff00" },
                { value: 5, color: "#ffa500" },
            ];

            colors.forEach(({ value, color }) => {
                const swatch = document.createElement("div");
                swatch.className = "color-swatch";
                swatch.style.backgroundColor = color;
                swatch.dataset.value = value;
                swatch.title = `Valeur: ${value}`;
                swatch.addEventListener("click", () => {
                    currentColorValue = value; // Met à jour la couleur sélectionnée
                    currentColor = color;
                });
                colorPaletteDiv.appendChild(swatch);
            });
        }

        function applyColorToTile(tileDiv) {
            const row = tileDiv.dataset.row;
            const col = tileDiv.dataset.col;
            const layer = layers[currentLayerIndex];
            const dataElem = layer.getElementsByTagName("data")[0];
            const width = parseInt(layer.getAttribute("width"), 10);

            // Met à jour la valeur dans le fichier XML
            const tileData = dataElem.textContent.trim().split(",").map(Number);
            tileData[row * width + parseInt(col)] = currentColorValue;

            dataElem.textContent = tileData.join(",");
            tileDiv.style.backgroundColor = currentColor;
            tileDiv.dataset.value = currentColorValue;
        }

        function saveLevel() {
            const serializer = new XMLSerializer();
            const newXmlContent = serializer.serializeToString(xmlDoc);
            const modifiedFileName = `${currentFileName}_modifié.xml`; // Nom de fichier modifié

            const blob = new Blob([newXmlContent], { type: "application/xml" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = modifiedFileName;
            a.click();
            URL.revokeObjectURL(url); // Libère l'URL après téléchargement
        }
    </script>
</body>
</html>
